---
title: "Introduction to planning phase II and phase III trials with drugdevelopR"
author: "Johannes Cepicka, Lukas D. Sauer"
date: "22/05/29"
output: rmarkdown::html_vignette
description: |
  Learn how to use the drugdevelopR package with a hands-on oncological example.
vignette: >
  %\VignetteIndexEntry{Introduction to planning phase II and phase III trials with drugdevelopR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Suppose we are planning a drug development program testing the superiority of an experimental treatment over a control treatment. Our  drug development program consists of an exploratory phase II trial which is, in case of promising results, followed by a confirmatory phase III trial.

The drugdevelopR package enables us to plan such programs. Specifically, it calculates

* the optimal sample size for phase II and the resulting sample size for phase III, as well as
* the optimal go/no-go decision rule.

The decision rule is the optimal threshold for deciding whether we should proceed to phase III based on the results of phase II. Optimization is performed with respect to a utility function which takes the program's cost, its success probability and its benefit for the patient into account. (TODO: Stimmt das? Gains oder benefit? Lass uns überall den gleichen Begriff verwenden.)

But now, let's get started with a hands-on example.

# The example setting

Suppose we are developing a new tumor treatment, *exper*. The patient variable that we want to investigate is the difference in tumor width between the one-year visit and baseline. This is a normally distributed outcome variable.

Within our drug development program, we will compare our experimental treatment *exper* to the control treatment *contro*. Building on available data, we expect that the mean tumor difference amounts to $11.1±1.1 \mathrm{mm}$ for *contro* and $99.9.±9.9 \mathrm{mm}$ for *exper*. (TODO: Ändere die Zahlenwerte hier so wie es passt) (TODO: Wie berechnet sich der standartisierte Behandlungsunterschied?) Thus, we obtain a standardized treatment difference of $\Delta_1 = 0.999$. (TODO: Ändere hier den Zahlenwert)

# Applying the package to the example

After installing the package according to the [installation instructions](https://sterniii3.github.io/drugdevelopR/#Installation), we can load it using the following code:
```{r}
# library(drugdevelopR)
```

## Defining all necessary parameters

In order to apply the package to the setting from our example, we need to specify the following parameters:

* `Delta1` is the assumed true treatment effect, defined as the standardized difference in means between the treatment arm and the control arm. We will use the value $\Delta_1 = 0.999$ as defined above. For now, we will assume that the treatment effects are fixed and independent of any prior distribution. Thus, we will set `fixed = TRUE`.
* `n2min` and `n2max` specify the minimal and maximal number of participants for the phase II trial. The package will search for the optimal sample size within this region. For now, we want the program to search for the optimal sample size in the interval between 20 and 100 participants. In addition, we will tell the program to search this region in steps of four participants at a time by setting `stepn2 = 4`.
* `kappamin` and `kappamax` specify the minimal and maximal threshold value for the go/no-go decision rule. The package will search for the optimal threshold value within this region. For now, we want the program to search in the interval between 0.02 and 0.2 while going in steps of `stepkappa = 0.02`.
* `c2` and `c3` are fixed maximal costs for phase II and phase III respectively. We will set the phase II costs to 0.675 and the phase III costs to 0.72. (TODO: Stimmt es, dass es sich hierbei um die festen maximalen Kosten handelt? Ich fände es schön, wenn es hier noch eine Interpretation gäbe. Sind mit diesem Kommazahlen der Anteil an einer Gesamtsumme gemeint, also z.B. 0.675 =67.5% der Gesamtkosten? Oder handelt es sich um Millionen Euro, also 0.675 = 675 000€?)
* `c02` and `c03` are the maximal costs in phase II and phase III per patient. We will set them to be 15 in phase II and 20 in phase III. (TODO: Stimmt es, dass es sich hierbei um maximale Kosten handelt? Was ist die Interpretation hiervon von diesen Kosten? Euro?)
* `b1`, `b2` and `b3` are the expected small, medium and large gains for the patients for each effect size category. We will define a small benefit of 3000, a medium benefit of 8000, and a large benefit of 10000. (TODO: Was sind "effect size categories"? Können wir den Begriff erklären? Was sind "gains"? Können wir den Begriff erklären? Vielleicht wäre "benefit" hier ein besserer Begriff. Dann sollten wir aber auch erklären, inwiefern diese Zahlen die Vorzüge für die Patient*in darstellen.)
* `alpha` is the specified significance level. We will set `alpha = 0.05`.
* 1 - `beta` is the minimal power that we require for our drug development program. We will set `beta = 0.1`, meaning that we require a power of 90%.
* Further parameters: In more advanced settings, we would need to pre-specify even more parameters. For now, we can set all remaining parameters to `NULL`. Their use is explained in the [vignette on parameters](vignette-parameters.html).

Now that we have defined all parameters needed for our example, we are ready to feed them to the package. We will use the function `optimal_normal()`, which calculates the optimal sample size and the optimal threshold value for a normally distributed outcome variable.
```{r}
# res <- optimal_normal(Delta1 = 0.375, fixed = TRUE, # treatment effect
#                       n2min = 20, n2max = 100, # sample size region
#                       stepn2 = 4, # sample size step size
#                       kappamin = 0.02, kappamax = 0.2, # threshold region
#                       stepkappa = 0.02, # threshold step size
#                       c2 = 0.675, c3 = 0.72, # maximal total trial costs
#                       c02 = 15, c03 = 20, # maximal per-patient costs
#                       b1 = 3000, b2 = 8000, b3 = 10000, # gains for patients
#                       alpha = 0.05, # significance level
#                       beta = 0.1, # 1 - power
#                       Delta2 = NULL, w = NULL, in1 = NULL, in2 = NULL, a = NULL,
#                       b = NULL) # setting all unneeded parameters to NULL
# res <- optimal_normal(w=0.3, Delta1 = 0.375, Delta2 = 0.625, 
#                       in1=300, in2=600,  a = 0.25, b = 0.75,  
#                       n2min = 20, n2max = 100, stepn2 = 4,
#                       kappamin = 0.02, kappamax = 0.2, stepkappa = 0.02,      #                       alpha = 0.05, beta = 0.1,  
#                       c2 = 0.675, c3 = 0.72, c02 = 15, c03 = 20,  
#                       b1 = 3000, b2 = 8000, b3 = 10000) 
```

## Interpreting the output

(TODO: Wie machen wir das mit der Ausgabe der Funktion oben? Vorschlag: Wir unterdrücken das Ausführen des obigen R-Chunks mit `eval = FALSE`. Dann führst du den Code einmal bei dir auf dem Computer aus und speicherst das Objekt `res` als .RDS-Datei im vignettes/-Unterordner ab, am Besten mit selbsterklärendem Namen wie `introduction-to-drugdevelopR-example.RDS`. Dann können wir das in einem unsichtbaren R-Chunk (`include=FALSE`) in dieser Vignette in das Objekt `res` laden und anschließend im nächsten Code-Chunk aufrufen.)

After setting all these input parameters and running the function, let's take a look at the output of the program.

```{r}
# res
```


The program returns a total of thirteen values. For now, we will only look at the most important ones:

* `res$n2` is the optimal sample size for phase II and `res$n3` the resulting sample size for phase III. We see that the optimal scenario requires 111 participants in phase II and 999 participants in phase III. (TODO: Zahlenwerte ändern.)
* `res$kappa` is the optimal threshold value for the go/no-go decision rule. We see that we need a treatment effect of more than 0.99 in phase II in order to proceed to phase III. (TODO: Zahlenwerte ändern.)
* `res$u` is the expected utility of the program for the optimal sample size and threshold value. In our case it amounts to 999. (TODO: Zahlenwerte ändern.)


# Where to go from here

This tutorial only covered drugdevelopR's basic setting. Luckily, the package's functionality extends to a multitude of different settings. If the example above doesn't suit your needs, you can adapt it to your specific setting:

* *Different outcomes:* Apply it to binary endpoints and time-to-event endpoints.
* *Interpreting the rest of the output:* Obtain further details on your drug development program.
* *Fixed or prior:* Model the assumed treatment effect on a prior distribution.
* *More parameters:* Define custom effect size categories. Put constraints on the optimization by defining maximum costs, the total expected sample size of the program or the minimum expected probability of a successful program. Define an expected difference in treatment effect between phase II and III. Skip phase II.
* *Complex drug development programs:* Adapt to situations with biased effect estimators, multiple phase III trials, multi-arm trials, or multiple endpoints.
* *Parallel computing:* Be faster at calculating the optimum by using parallel computing.